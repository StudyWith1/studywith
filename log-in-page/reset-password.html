<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StudyWith</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../log-in-page/forgot-password.css" />
    <link rel="icon" href="../images/menu-logo.ico" />
  </head>
  <body>
    <script src="../header/auth-header.js"></script>

    <main class="forgot-password-container">
      <section>
        <img
          src="../images/forgot-password.jpg"
          alt="Illustration"
          class="illustration"
        />
      </section>

      <section class="forgot-section">
        <img src="../images/arrow.jpg" alt="Arrow" class="arrow" />
        <div class="forgot-box">
          <h2 data-lang="heading">Reset password</h2>
          <p data-lang="description">Create a new password for your account.</p>
          <div class="password-things1">
            <input
              type="password"
              id="password1"
              class="password-input"
              placeholder="New password"
              data-lang="passPlaceholder"
              oninput="this.value = this.value.replace(/[^a-zA-ZĞ°-ÑĞ-Ğ¯Ñ—Ğ‡Ñ”Ğ„Ñ–Ğ†Ò‘Ò0-9]/g, '')"
            />
            <button
              type="button"
              id="toggle-password1"
              class="button-view1"
              onclick="togglePasswordVisibility('password1', this)"
            >
              ğŸ‘ï¸
            </button>
          </div>
          <div class="password-things2">
            <input
              type="password"
              id="password2"
              class="confirm-password-input"
              placeholder="Confirm password"
              data-lang="repass"
              oninput="this.value = this.value.replace(/[^a-zA-ZĞ°-ÑĞ-Ğ¯Ñ—Ğ‡Ñ”Ğ„Ñ–Ğ†Ò‘Ò0-9]/g, '')"
            />
            <button
              type="button"
              id="toggle-password2"
              class="button-view2"
              onclick="togglePasswordVisibility('password2', this)"
            >
              ğŸ‘ï¸
            </button>
          </div>
          <div id="error-message" style="color: red; margin-bottom: 10px"></div>
          <button class="btn reset-password-btn" data-lang="continueButton">
            Reset password
          </button>
        </div>
      </section>
    </main>
    <script src="../footer/footer.js"></script>
    <script>
      function togglePasswordVisibility(inputId, toggleButton) {
        const passwordField = document.getElementById(inputId);

        if (passwordField.type === "password") {
          passwordField.type = "text";
          toggleButton.textContent = "ğŸ™ˆ";
        } else {
          passwordField.type = "password";
          toggleButton.textContent = "ğŸ‘ï¸";
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM fully loaded and parsed");

        const passwordInput = document.querySelector(".password-input");
        const confirmPasswordInput = document.querySelector(
          ".confirm-password-input"
        );
        const resetPasswordButton = document.querySelector(
          ".reset-password-btn"
        );

        // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ½Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ² Ğ· URL
        function getQueryParam(param) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(param);
        }

        // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½ Ğ· URL
        const token = getQueryParam("token");

        // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°, Ñ‡Ğ¸ Ğ²ÑÑ– ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¸ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ–
        if (!passwordInput || !confirmPasswordInput || !resetPasswordButton) {
          console.error("One or more elements not found");
          return; // Ğ’Ğ¸Ñ…Ñ–Ğ´, ÑĞºÑ‰Ğ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ· ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾
        }

        resetPasswordButton.addEventListener("click", async (event) => {
          event.preventDefault(); // Ğ—Ğ°Ğ¿Ğ¾Ğ±Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºĞ¸

          const password = passwordInput.value.trim();
          const confirmPassword = confirmPasswordInput.value.trim();
          const minPasswordLength = 6;
          const errorElement = document.getElementById("error-message");

          const fillfields = {
            en: `Please fill in both password fields`,
            ua: `Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ`,
          };

          const currentLang = localStorage.getItem("language");

          if (!password || !confirmPassword) {
            errorElement.textContent = fillfields[currentLang];
            return;
          }

          const shortpass = {
            en: `Password must be at least ${minPasswordLength} characters long`,
            ua: `ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ¼Ğ°Ñ” Ğ±ÑƒÑ‚Ğ¸ Ñ‰Ğ¾Ğ½Ğ°Ğ¹Ğ¼ĞµĞ½ÑˆĞµ ${minPasswordLength} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ² Ğ·Ğ°Ğ²Ğ´Ğ¾Ğ²Ğ¶ĞºĞ¸`,
          };

          if ((password.length > 1) & (password.length < minPasswordLength)) {
            errorElement.textContent = shortpass[currentLang];
            return;
          }

          const match = {
            en: `Passwords do not match`,
            ua: `ĞŸĞ°Ñ€Ğ¾Ğ»Ñ– Ğ½Ğµ ÑĞ¿Ñ–Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ÑŒ`,
          };

          if (password !== confirmPassword) {
            errorElement.textContent = match[currentLang];
            return;
          }

          try {
            console.log("Sending request to server...");
            const response = await fetch(
              "http://localhost:8000/auth/reset-password",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ token, password }), // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½ Ğ· URL
              }
            );

            const data = await response.json();
            console.log("Response received:", data);

            if (response.ok) {
              alert(data.message);
              window.location.href = "/login"; // ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºÑƒ Ğ²Ñ…Ğ¾Ğ´Ñƒ
            } else {
              alert(data.error);
              console.error("Error response:", data.error);
            }
          } catch (error) {
            console.error("Fetch error:", error);
            alert("An error occurred. Please try again later.");
          }
        });
      });
    </script>
    <script>
      const translations = {
        en: {
          pageTitle: "StudyWith | Reset Your Password",
          heading: "Reset password",
          description: "Create a new password for your account.",
          passPlaceholder: "New password",
          repass: "Confirm password",
          continueButton: "Reset password",
        },
        ua: {
          pageTitle: "StudyWith | Ğ¡ĞºĞ¸Ğ´Ğ°Ğ½Ğ½Ñ ĞŸĞ°Ñ€Ğ¾Ğ»Ñ",
          heading: "Ğ¡ĞºĞ¸Ğ´Ğ°Ğ½Ğ½Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ",
          description: "Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñƒ",
          passPlaceholder: "ĞĞ¾Ğ²Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ",
          repass: "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ñ–Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ",
          continueButton: "Ğ¡ĞºĞ¸Ğ½ÑƒÑ‚Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ",
        },
      };

      function applyLanguage(lang) {
        const langData = translations[lang];

        document.title = langData.pageTitle;

        document.querySelectorAll("[data-lang]").forEach((element) => {
          const langKey = element.getAttribute("data-lang");
          if (langData[langKey]) {
            if (element.tagName === "INPUT") {
              element.setAttribute("placeholder", langData[langKey]);
            } else if (element.tagName === "BUTTON") {
              element.textContent = langData[langKey];
            } else if (element.tagName === "H2") {
              element.textContent = langData[langKey];
            } else if (element.tagName === "P") {
              element.textContent = langData[langKey];
            } else {
              element.innerHTML = langData[langKey];
            }
          }
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const userLang = localStorage.getItem("language"); // Default to English
        applyLanguage(userLang);
      });
    </script>
  </body>
</html>
